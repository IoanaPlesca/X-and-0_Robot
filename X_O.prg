MODULE pozitii
  CONST robtarget o_4_j:=[[334.53,119.7,42.9],[0.001017,-0.718548,-0.69528,-0.016583],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_5_j:=[[335.1,249.8,40.61],[0.000975,-0.71853,-0.695298,-0.016597],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_4_j:=[[337.41,383.51,39.11],[0.000957,-0.7185,-0.69533,-0.016573],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget o_3_j:=[[212.41,116.8,43.05],[0.000913,-0.71849,-0.695341,-0.016543],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget o_2_j:=[[214.61,256.31,42.22],[0.000848,-0.718436,-0.695398,-0.01651],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget o_1_j:=[[212.85,381.01,39.11],[0.000723,-0.718369,-0.695468,-0.016486],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_3_j:=[[77.04,119.45,38.94],[0.000643,-0.718326,-0.695513,-0.016426],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_2_j:=[[77.55,248.75,40.31],[0.000574,-0.71829,-0.69555,-0.016428],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_1_j:=[[78.57,385.3,36.54],[0.000541,-0.718231,-0.695611,-0.016429],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_1_s:=[[74.457545644,381.045970415,216.442726359],[0.000541,-0.718230771,-0.695610778,-0.016428995],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget o_1_s:=[[208.767533502,376.695457133,219.011968269],[0.000722999,-0.718368256,-0.69546728,-0.016485983],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_2_s:=[[73.445706063,244.488036354,220.21272493],[0.000574,-0.718289808,-0.695549814,-0.016427996],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_3_s:=[[72.953280564,115.170906614,218.84271839],[0.000643,-0.718325712,-0.695512721,-0.016425993],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_4_s:=[[333.362789598,379.113936272,219.010791304],[0.000956999,-0.718499411,-0.69532943,-0.016572986],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget x_5_s:=[[331.050894594,245.393450938,220.510492136],[0.000974999,-0.718529612,-0.695297624,-0.016596991],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget o_2_s:=[[210.552202762,251.957516845,222.121612477],[0.000847999,-0.718435295,-0.695397317,-0.016509984],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget o_3_s:=[[208.359597729,112.422763811,222.951178553],[0.000912999,-0.718489464,-0.695340482,-0.016542988],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget o_4_s:=[[330.494916794,115.286193945,222.800629292],[0.001016999,-0.718547448,-0.695279466,-0.016582987],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  
  PERS tooldata Efector:=[TRUE,[[25,0.0330337,184.3],[1,0,0,0]],[1.5,[0,0,90],[1,0,0,0],0.01,0.01,0.01]];
  PERS wobjdata proiect:=[FALSE,TRUE,"",[[457.8448444,-1078.513142243,826.999419811],[0.923872705,-0.003076559,0.00113094,0.382685878]],[[0,0,0],[1,0,0,0]]];
  CONST robtarget gripper:=[[1209.21,314.088,245.592],[0.462916,0.332954,0.799532,-0.188679],[-1,0,-1,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget g_spate:=[[555.14,480.131,238.239],[0.000801646,-0.707075,-0.706937,-0.0168625],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  
  CONST robtarget cub_1_s:=[[555.035,367.466,236.974],[0.000863999,-0.707088,-0.706923,-0.016878],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_1_j:=[[559.496759698,372.407457051,40.086565542],[0.000863999,-0.70708829,-0.70692329,-0.016877983],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_2_s:=[[552.975,239.703,234.104],[0.000855999,-0.707107,-0.706904,-0.016861],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_2_j:=[[557.424181785,244.626304905,39.461144655],[0.000860404,-0.707104953,-0.706907014,-0.016861784],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_3_s:=[[555.173,120.243,229.246],[0.000801646,-0.707075,-0.706937,-0.0168625],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_3_j:=[[558.760009536,124.184056839,38.886644996],[0.000799148,-0.707074314,-0.706937732,-0.016861758],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_4_s:=[[675.724916549,366.933132782,230.970445552],[0.000878826,-0.707111044,-0.70690075,-0.016867959],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_4_j:=[[679.841418888,371.499911689,40.616658324],[0.000878826,-0.707111044,-0.70690075,-0.016867959],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_5_s:=[[687.331380461,234.469291855,230.383659082],[0.000816759,-0.707135905,-0.70687566,-0.016880313],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_5_j:=[[688.177549758,235.386801931,39.997750274],[0.000816759,-0.707135905,-0.70687566,-0.016880313],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_6_s:=[[690.483765581,95.38576703,229.727396837],[0.000859862,-0.707141886,-0.706869184,-0.01689883],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_6_j:=[[691.329934879,96.303277106,39.341488029],[0.000859862,-0.707141886,-0.706869184,-0.01689883],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_7_s:=[[814.566791017,366.074703722,231.583390674],[0.002237708,0.707149213,0.706894299,0.015343834],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_7_j:=[[815.429346831,367.001720553,42.04983215],[0.002237708,0.707149213,0.706894299,0.015343834],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_8_s:=[[814.540758594,231.08888012,230.932749658],[0.002237708,0.707149213,0.706894299,0.015343834],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_8_j:=[[815.387187958,234.006046525,40.583915078],[0.002237708,0.707149213,0.706894299,0.015343834],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_9_s:=[[813.159213719,98.31983826,230.286767215],[0.002206778,0.707143086,0.706900659,0.015337689],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];
  CONST robtarget cub_9_j:=[[813.881323881,99.144531189,44.89845726],[0.002206778,0.707143086,0.706900659,0.015337689],[-1,0,0,0],[9E+09,9E+09,9E+09,9E+09,9E+09,9E+09]];

  !o si x sunt variabilele in care vom stoca pozitiile pe care sunt puse x si o
  PERS string o:=""; !trebuie pus null la inceput
  PERS string x:=""; !trebuie pus null la inceput 
  PERS num cnt_x:=0; !trebuie pus 0 la inceput
  PERS num cnt_o:=0; !trebuie pus 0 la inceput
  PERS num piese:=9; !trebuie pus 9 la inceput(nr piese)
  PERS num alegere:=2; !trebuie pus 2 sau 3 la inceput(1 sau 0 sunt alegerile piesei)
    
    PROC Poz_1()
    MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    MoveL cub_1_s,v300,fine,Efector\WObj:=proiect;
    MoveL cub_1_j,v300,fine,Efector\WObj:=proiect;
    WaitTime 1;
    SetDO DO10_9,1;
    WaitTime 1;
    MoveL cub_1_s,v300,fine,Efector\WObj:=proiect;
    MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    
  ENDPROC

  PROC Poz_2()
    MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    MoveL cub_2_s,v300,fine,Efector\WObj:=proiect;
    MoveL cub_2_j,v300,fine,Efector\WObj:=proiect;
    WaitTime 1;
    SetDO DO10_9,1;
    WaitTime 1;
    MoveL cub_2_s,v300,fine,Efector\WObj:=proiect;
    MoveL g_spate,v300,fine,Efector\WObj:=proiect;
  ENDPROC

  PROC Poz_3()
    MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    MoveL cub_3_s,v300,fine,Efector\WObj:=proiect;
    MoveL cub_3_j,v300,fine,Efector\WObj:=proiect;
    WaitTime 1;
    SetDO DO10_9,1;
    WaitTime 1; 
    MoveL cub_3_s,v300,fine,Efector\WObj:=proiect;
    MoveL g_spate,v300,fine,Efector\WObj:=proiect;
  ENDPROC
  
  PROC Poz_4()
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
        MoveL cub_4_s,v300,fine,Efector\WObj:=proiect;
        MoveL cub_4_j,v300,fine,Efector\WObj:=proiect;
        WaitTime 1;
        SetDO DO10_9,1;
        WaitTime 1;
        MoveL cub_4_s,v300,fine,Efector\WObj:=proiect;
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
  ENDPROC
  
    PROC Poz_5()
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
        MoveL cub_5_s,v300,fine,Efector\WObj:=proiect;
        MoveL cub_5_j,v300,fine,Efector\WObj:=proiect;
        WaitTime 1;
        SetDO DO10_9,1;
        WaitTime 1;
        MoveL cub_5_s,v300,fine,Efector\WObj:=proiect;
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    ENDPROC
    
    PROC Poz_6()
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
        MoveL cub_6_s,v300,fine,Efector\WObj:=proiect;
        MoveL cub_6_j,v300,fine,Efector\WObj:=proiect;
        WaitTime 1;
        SetDO DO10_9,1;
        WaitTime 1;
        MoveL cub_6_s,v300,fine,Efector\WObj:=proiect;
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    ENDPROC
    
    PROC Poz_7()
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
        MoveL cub_7_s,v300,fine,Efector\WObj:=proiect;
        MoveL cub_7_j,v300,fine,Efector\WObj:=proiect;
        WaitTime 1;
        SetDO DO10_9,1;
        WaitTime 1;
        MoveL cub_7_s,v300,fine,Efector\WObj:=proiect;
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    ENDPROC
    
    PROC Poz_8()
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
        MoveL cub_8_s,v300,fine,Efector\WObj:=proiect;
        MoveL cub_8_j,v300,fine,Efector\WObj:=proiect;
        WaitTime 1;
        SetDO DO10_9,1;
        WaitTime 1;
        MoveL cub_8_s,v300,fine,Efector\WObj:=proiect;
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    ENDPROC
    
    PROC Poz_9()
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
        MoveL cub_9_s,v300,fine,Efector\WObj:=proiect;
        MoveL cub_9_j,v300,fine,Efector\WObj:=proiect;
        WaitTime 1;
        SetDO DO10_9,1;
        WaitTime 1;
        MoveL cub_9_s,v300,fine,Efector\WObj:=proiect;
        MoveL g_spate,v300,fine,Efector\WObj:=proiect;
    ENDPROC
   
  PROC Home_pick()
    SetDO DO10_9,1;
    MoveJ gripper,v300,fine,Efector\WObj:=proiect;
    MoveL g_spate,v300,fine,Efector\WObj:=proiect;
  ENDPROC

!in functie de cate piese X am mutat deja, locul din care ia urmatoarea piesa X se schimba
!sunt luate in ordine
   PROC pick_X()
        cnt_x:=cnt_x+1;
        IF cnt_x=1 THEN
            MoveL x_1_s,v300,fine,Efector\WObj:=proiect;
            MoveL x_1_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1;  
            MoveL x_1_s,v300,fine,Efector\WObj:=proiect;
        ELSEIF cnt_x=2 THEN
            MoveL x_2_s,v300,fine,Efector\WObj:=proiect;
            MoveL x_2_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1;
            MoveL x_2_s,v300,fine,Efector\WObj:=proiect;
        ELSEIF cnt_x=3 THEN
            MoveL x_3_s,v300,fine,Efector\WObj:=proiect;
            MoveL x_3_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1; 
            MoveL x_3_s,v300,fine,Efector\WObj:=proiect;
        ELSEIF cnt_x=4 THEN
            MoveL x_4_s,v300,fine,Efector\WObj:=proiect;
            MoveL x_4_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1; 
            MoveL x_4_s,v300,fine,Efector\WObj:=proiect;
        ELSEIF cnt_x=5 THEN
            MoveL x_5_s,v300,fine,Efector\WObj:=proiect;
            MoveL x_5_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1; 
            MoveL x_5_s,v300,fine,Efector\WObj:=proiect;
        ENDIF
     
    ENDPROC
  
!in functie de cate piese O am mutat deja, locul din care ia urmatoarea piesa O se schimba
!sunt luate in ordine
     PROC pick_O()
        cnt_o:=cnt_o+1;
        IF cnt_o=1 THEN
            MoveL o_1_s,v300,fine,Efector\WObj:=proiect;
            MoveL o_1_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1; 
            MoveL o_1_s,v300,fine,Efector\WObj:=proiect;
        ELSEIF cnt_o=2 THEN
            MoveL o_2_s,v300,fine,Efector\WObj:=proiect;
            MoveL o_2_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1;
            MoveL o_2_s,v300,fine,Efector\WObj:=proiect;
        ELSEIF cnt_o=3 THEN
            MoveL o_3_s,v300,fine,Efector\WObj:=proiect;
            MoveL o_3_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1;
            MoveL o_3_s,v300,fine,Efector\WObj:=proiect;
        ELSEIF cnt_o=4 THEN
            MoveL o_4_s,v300,fine,Efector\WObj:=proiect;
            MoveL o_4_j,v300,fine,Efector\WObj:=proiect;
            WaitTime 1;
            SetDO DO10_9,0;
            WaitTime 1;
            MoveL o_4_s,v300,fine,Efector\WObj:=proiect;
        ENDIF
        
    ENDPROC
    
!in functie de ce piesa mut(X sau O), pozitia se memoreaza in string-ul respectiv
    PROC memorare_Poz(num alegere,string p)
        IF alegere=1 THEN
            x:=x+p;
        ELSEIF alegere=0 THEN
            o:=o+p;
        ENDIF
    ENDPROC
    
!verifica daca pozitiile lui X sau O sunt combinatii de castig
FUNC num verif_castig(string sir)
        CONST string castig{8}:=["123","456","789","147","258","369","159","753"]; !toate variantele de castig
        VAR num i;
        VAR num j;
        VAR string comb;
        VAR string c;
        VAR num gasit;
 
        FOR i FROM 1 TO 8 DO
            comb := castig{i}; !extrag una din combinatiile de mai sus
            gasit:=1;
            TPWrite "nr comb:"+comb;
            FOR j FROM 1 TO 3 DO 
                !cautam sa gasim comb in sir deoarece poate fi situatie de castig si daca sir=1579
                IF StrMemb(comb,j,sir)=FALSE THEN !daca nu gasesc toate caracterele din comb in sir, atunci gasit primeste 0
                    gasit:=0;
                  ! ExitCycle;
                ENDIF   
            ENDFOR

            IF gasit = 1 THEN
                RETURN 1;!daca a fost gasita o combinatie corecta, returneaza valoare 1 
            ENDIF
        ENDFOR
        
        RETURN 0;!daca nu a fost gasita o combinatie corecta, returneaza valoare 0 
ENDFUNC
  

!procedura pentru alegerea piesei de catre utilizator
!in functie de pozitia dorita, se apeleaza path-ul respectiv
  PROC program()
    VAR num poz_final;
    VAR num poz_initial;
    VAR num conditie:=0;
    
    WHILE conditie=0 DO
        TPReadNum poz_initial,"X(1) sau O(0)?";
        IF poz_initial=1 THEN
            IF cnt_x<=cnt_o AND alegere<>1 THEN
                pick_X;
                alegere:=1; !pentru a sti ce piesa este mutata
                conditie:=1; !pentru a iesi din while
            ELSE
                TPWrite "Nu se poate!"; !nu se poate alege X consecutiv
                TPWrite "Alege O";
                conditie:=0; !pentru a intra din nou in while
            ENDIF
        ELSEIF poz_initial=0 THEN
            IF cnt_o<=cnt_x AND alegere<>0 THEN 
                pick_O;
                alegere:=0; !pentru a sti ce piesa este mutata
                conditie:=1; !pentru a iesi din while
            ELSE
                TPWrite "Nu se poate!"; !nu se poate alege O consecutiv
                TPWrite "Alege X";
                conditie:=0; !pentru a intra din nou in while
            ENDIF
        ENDIF
    ENDWHILE
    
    TPReadNum poz_final,"Alegeti pozitia finala:";
    IF poz_final=1 THEN 
      Poz_1; !se apeleaza path-ul pentru pozitia 1
      memorare_Poz alegere,"1"; !se memoreaza in string pozitia aleasa
    ELSEIF poz_final=2 THEN
      Poz_2;
      memorare_Poz alegere,"2";
    ELSEIF poz_final=3 THEN
        Poz_3;
        memorare_Poz alegere,"3";
    ELSEIF poz_final=4 THEN
        Poz_4;
        memorare_Poz alegere,"4";
    ELSEIF poz_final=5 THEN
        Poz_5;
        memorare_Poz alegere,"5";
    ELSEIF poz_final=6 THEN
        Poz_6;
        memorare_Poz alegere,"6";
    ELSEIF poz_final=7 THEN
        Poz_7;
        memorare_Poz alegere,"7";
    ELSEIF poz_final=8 THEN
        Poz_8;
        memorare_Poz alegere,"8";
    ELSEIF poz_final=9 THEN
        Poz_9;
        memorare_Poz alegere,"9";
    ENDIF
  ENDPROC

  PROC main()
      VAR num verificare;
      Home_pick; !programul incepe mereu din pozitia home cu gripper-ul deschis
    WHILE piese>0 DO !cat timp mai sunt piese disponibile
        program;!alegere piesa si pozitie
        piese:= piese-1;!scade numarul de piese disponibile
        verificare:=0; !plecam de la premiza ca nu avem niciun castig
        IF alegere=1 AND StrLen(x)>=3 THEN !daca au fost puse pe tabla minim 3 piese de X, se verfica posibilitatea de castig
            verificare:=verif_castig(x); 
        ELSEIF alegere=0 AND StrLen(o)>=3 THEN !daca au fost puse pe tabla minim 3 piese de O, se verfica posibilitatea de castig
            verificare:=verif_castig(o);
        ENDIF
        
        IF verificare=1 AND alegere=1 THEN
            TPWrite "X a castigat";
            piese:=0;
        ELSEIF verificare=1 AND alegere=0 THEN
            TPWrite "O a castigat";
            piese:=0;
        ENDIF
        
    ENDWHILE
    MoveJ gripper,v300,fine,Efector\WObj:=proiect; !se duce inapoi in pozitia de home
  ENDPROC

ENDMODULE

